<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Banquinha Mobile | Portal de Aplicações</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #FFD700;
            --dark: #0A0A0A;
            --dark-card: #141414;
            --gray-400: #8C8C8C;
            --white: #FFFFFF;
            --gradient-primary: linear-gradient(135deg, #FFD700 0%, #FFE44D 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: var(--white); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
        
        .header { padding: 32px 0; display: flex; justify-content: space-between; align-items: center; }
        .brand-name { font-family: 'Space Grotesk'; font-size: 1.75rem; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .hero { padding: 60px 0; text-align: center; }
        .hero-title { font-family: 'Space Grotesk'; font-size: 3rem; margin-bottom: 16px; }
        
        .platforms-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; margin-top: 40px; }
        .card { background: var(--dark-card); padding: 40px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
        
        .btn { background: var(--gradient-primary); color: var(--dark); padding: 14px 32px; border-radius: 12px; text-decoration: none; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; border: none; cursor: pointer; transition: 0.3s; width: 100%; justify-content: center; margin-top: 20px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Modal */
        #qrModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--dark-card); padding: 40px; border-radius: 24px; text-align: center; max-width: 400px; border: 1px solid var(--primary); }
        #qrcode-container { background: white; padding: 15px; border-radius: 10px; display: inline-block; margin: 20px 0; }
        
        .version-badge { font-size: 0.8rem; color: var(--primary); font-weight: bold; border: 1px solid var(--primary); padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <header class="container header">
        <div class="brand-name">Smoking Bee</div>
        <div class="version-badge" id="current-version">v1.0.5</div>
    </header>

    <section class="hero container">
        <h1 class="hero-title">Portal de Aplicações</h1>
        <p style="color: var(--gray-400)">Sempre a versão mais recente para o seu dispositivo.</p>

        <div class="platforms-grid">
            <div class="card">
                <i class="fab fa-android" style="font-size: 48px; color: var(--primary)"></i>
                <h3 style="margin-top: 16px;">Android</h3>
                <p style="color: #aaa; font-size: 0.9rem;">Instalador nativo (APK)</p>
                <button class="btn" onclick="initiateDownloadFlow()">
                    <i class="fas fa-qrcode"></i> <span id="btn-text">Baixar APK</span>
                </button>
            </div>

            <div class="card">
                <i class="fab fa-apple" style="font-size: 48px; color: #8B5CF6"></i>
                <h3 style="margin-top: 16px;">iPhone (iOS)</h3>
                <p style="color: #aaa; font-size: 0.9rem;">Web App PWA</p>
                <a href="https://smokingbee.com.br" class="btn" style="background: #8B5CF6; color: white;">Acessar Loja</a>
            </div>
        </div>
    </section>

    <div id="qrModal">
        <div class="modal-content">
            <h3 id="modalTitle">Instalar App</h3>
            <div id="qrcode-container"></div>
            <p style="font-size: 14px; color: #888;">Aponte a câmera para iniciar o download direto do instalador.</p>
            <button onclick="closeModal()" class="btn" style="margin-top: 20px;">Fechar</button>
        </div>
    </div>

    <script>
        let finalStreamUrl = "";

        // 1. Detecta a arquitetura
        function getAbi() {
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('arm64') || ua.includes('aarch64')) return 'arm64-v8a';
            return 'armeabi-v7a';
        }

        // 2. Fluxo Principal: Consulta /update-app -> Monta /download-stream
        async function initiateDownloadFlow() {
            const btnText = document.getElementById('btn-text');
            const abi = getAbi();
            
            try {
                btnText.textContent = "Verificando...";

                // Chamada da Rota 1: /update-app
                const checkUrl = `https://api.smokingbee.com.br/update-app?version=1.0&abi=${abi}&app_type=ecommerce`;
                const response = await fetch(checkUrl);
                const data = await response.json();

                if (data.download_url) {
                    // Chamada da Rota 2: Envelopa a URL no /download-stream
                    const encodedUrl = encodeURIComponent(data.download_url);
                    finalStreamUrl = `https://api.smokingbee.com.br/download-stream?url=${encodedUrl}`;

                    console.log("Fluxo de stream pronto:", finalStreamUrl);
                    
                    // Se estiver no Mobile, baixa direto. Se estiver no PC, mostra o QR Code.
                    if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        window.location.href = finalStreamUrl;
                    } else {
                        showQrCode(finalStreamUrl, data.new_version);
                    }
                }
            } catch (error) {
                console.error("Erro no fluxo de download:", error);
                alert("Erro ao conectar com o servidor. Tente novamente.");
            } finally {
                btnText.textContent = "Baixar APK";
            }
        }

        function showQrCode(url, version) {
            const container = document.getElementById("qrcode-container");
            container.innerHTML = "";
            document.getElementById('modalTitle').textContent = `Baixar v${version}`;
            
            new QRCode(container, {
                text: url,
                width: 220,
                height: 220,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        window.onclick = (e) => { if(e.target.id === 'qrModal') closeModal(); };
    </script>
</body>
</html>